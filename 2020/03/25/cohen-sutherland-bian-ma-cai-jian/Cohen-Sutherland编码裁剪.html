<hr>
<p>title: Cohen-Sutherland编码裁剪<br>author: 戈孔明<br>top: false<br>cover: false<br>toc: true<br>mathjax: true<br>date: 2020-03-25 21:35:08<br>img:<br>coverImg:<br>password:<br>summary:<br>tags:</p>
<ul>
<li>OpenGL</li>
<li>Cohen-Sutherland<br>categories:</li>
<li>计算机图形学</li>
</ul>
<hr>
<h2 id="Cohen-Sutherland编码裁剪算法"><a href="#Cohen-Sutherland编码裁剪算法" class="headerlink" title="Cohen-Sutherland编码裁剪算法"></a>Cohen-Sutherland编码裁剪算法</h2><h3 id="二维剪裁"><a href="#二维剪裁" class="headerlink" title="二维剪裁"></a>二维剪裁</h3><p>二维剪裁是在三维线段投影到投影平面之后才进行的，并且剪裁窗口是投影平面的一部分，该投影片面投影到屏幕的视口中，所有的值都可用实数表示。AB整段显示，CD整段不显示，EF和GH裁剪后显示</p>
<img width = '300' height ='200' src ="https://cdn.jsdelivr.net/gh/gkm0120/CDN/images/2020032901.jpg"/>

<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>为避免求交（所在直线与剪裁窗口各条边的交点）运算，Cohen-Sutherland算法使用浮点减法与位操作相结合的方式代替大量浮点乘法和除法的裁剪算法。<br>该算法把裁剪窗口的四条边延长，将二维空间分割成9个区域，并赋予每个区域一个唯一的四位二进制数（编码），编码的4位分别代表端点位于窗口的上、下、右、左。</p>
<img width = '300' height ='200' src ="https://cdn.jsdelivr.net/gh/gkm0120/CDN/images/2020032902.jpg"/>

<p><strong>考虑线段$ o_1 $$ o_2 $,对两端点的编码情况进行讨论，有四种情况：</strong></p>
<ol>
<li>若点$ o_1 $和$ o_2 $完全在裁剪窗口内，则保留该直线，如线段AB，然后进行光栅化处理</li>
<li>若点$ o_1 $和$ o_2 $有一个端点在裁剪窗口内，如线段CD，非零的端点编码说明线段与剪裁窗口的哪条边或拿两条边相交判断是否要进行两次求交运算</li>
<li>若$ o_1 $和$ o_2 $均不为0，对两个端点编码按位与运算，判断是否在同一侧，若是舍弃，如线段EF</li>
<li>如果直线段既不满足保留的条件，也不满足舍弃的条件？那么需要对直线段按交点进行分段，分段后判断直线是保留还是舍弃。（如GH与IJ)</li>
</ol>
<img width = '300' height ='200' src ="https://cdn.jsdelivr.net/gh/gkm0120/CDN/images/2020032903.jpg"/>

<blockquote>
<p>当要处理的线段很多，而实际显示的线段很少时，Cohen-Sutherland算法非常有效</p>
</blockquote>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><pre><code class="cpp"><span class="comment">/*cohen-surtherland.cpp*/</span>
<span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;gl/glut.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span>

<span class="meta">#<span class="meta-keyword">define</span> LEFT_EDGE 1</span>
<span class="meta">#<span class="meta-keyword">define</span> RIGHT_EDGE 2</span>
<span class="meta">#<span class="meta-keyword">define</span> BOTTOM_EDGE 4</span>
<span class="meta">#<span class="meta-keyword">define</span> TOP_EDGE 8</span>

<span class="function"><span class="keyword">void</span> <span class="title">LineGL</span><span class="params">(<span class="keyword">int</span> x0, <span class="keyword">int</span> y0, <span class="keyword">int</span> x1, <span class="keyword">int</span> y1)</span></span>{
  glBegin(GL_LINES);
  glColor3f(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>); glVertex2f(x0, y0);
  glColor3f(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>); glVertex2f(x1, y1);
  glEnd();
}

<span class="class"><span class="keyword">struct</span> <span class="title">Rectangle</span>{</span>
  <span class="keyword">float</span> xmin, xmax, ymin, ymax;
};

Rectangle rect;
<span class="keyword">int</span> x0, y0, x1, y1;

<span class="function"><span class="keyword">int</span> <span class="title">CompCode</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, Rectangle rect)</span></span>{
  <span class="keyword">int</span> code = <span class="number">0x00</span>;
  <span class="keyword">if</span> (y &lt; rect.ymin)
    code = code | <span class="number">4</span>;
  <span class="keyword">if</span> (y&gt;rect.ymax)
    code = code | <span class="number">8</span>;
  <span class="keyword">if</span> (x&gt;rect.xmax)
    code = code | <span class="number">2</span>;
  <span class="keyword">if</span> (x&lt;rect.xmin)
    code = code | <span class="number">1</span>;
  <span class="keyword">return</span> code;
}
<span class="function"><span class="keyword">int</span> <span class="title">cohensutherlandlineclip</span><span class="params">(Rectangle rect, <span class="keyword">int</span> &amp;x0, <span class="keyword">int</span> &amp;y0, <span class="keyword">int</span> &amp;x1, <span class="keyword">int</span> &amp;y1)</span></span>
<span class="function"></span>{
  <span class="keyword">int</span> accept, done;
  <span class="keyword">float</span> x, y;
  accept = <span class="number">0</span>;
  done = <span class="number">0</span>;

  <span class="keyword">int</span> code0, code1, codeout;
  code0 = CompCode(x0, y0, rect);
  code1 = CompCode(x1, y1, rect);
  <span class="keyword">do</span>{
    <span class="keyword">if</span> (!(code0 | code1)){<span class="comment">//整条线段在窗口内</span>
      accept = <span class="number">1</span>;<span class="comment">//取之</span>
      done = <span class="number">1</span>;
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (code0 &amp; code1)<span class="comment">//两个端点同在窗口一侧，弃之</span>
      done = <span class="number">1</span>;
    <span class="keyword">else</span>{<span class="comment">//线段与窗口存在交点</span>
      <span class="keyword">if</span> (code0 != <span class="number">0</span>)
        codeout = code0;
      <span class="keyword">else</span>
        codeout = code1;
            <span class="comment">//求交点</span>
      <span class="keyword">if</span> (codeout&amp;LEFT_EDGE){
        y = y0 + (y1 - y0)*(rect.xmin - x0) / (x1 - x0);
        x = (<span class="keyword">float</span>)rect.xmin;
      }
      <span class="keyword">else</span> <span class="keyword">if</span> (codeout&amp;RIGHT_EDGE){
        y = y0 + (y1 - y0)*(rect.xmax - x0) / (x1 - x0);
        x = (<span class="keyword">float</span>)rect.xmax;
      }
      <span class="keyword">else</span> <span class="keyword">if</span> (codeout&amp;BOTTOM_EDGE){
        x = x0 + (x1 - x0)*(rect.ymin - y0) / (y1 - y0);
        y = (<span class="keyword">float</span>)rect.ymin;
      }
      <span class="keyword">else</span> <span class="keyword">if</span> (codeout&amp;TOP_EDGE){
        x = x0 + (x1 - x0)*(rect.ymax - y0) / (y1 - y0);
        y = (<span class="keyword">float</span>)rect.ymax;
      }
      <span class="comment">//舍弃在窗口外的部分线段</span>
      <span class="keyword">if</span> (codeout == code0){
        x0 = x; y0 = y;
        code0 = CompCode(x0, y0, rect);
      }
      <span class="keyword">else</span>
      {
        x1 = x; y1 = y;
        code1 = CompCode(x1, y1, rect);
      }
    }
  } <span class="keyword">while</span> (!done);
    <span class="keyword">if</span> (accept)
    LineGL(x0, y0, x1, y1);
  <span class="keyword">else</span>{
    x0 = <span class="number">0</span>; y = <span class="number">0</span>; x1 = <span class="number">0</span>; y1 = <span class="number">0</span>;
    LineGL(x0, y0, x1, y1);
  }
  <span class="keyword">return</span> accept;
}

<span class="function"><span class="keyword">void</span> <span class="title">myDisplay</span><span class="params">()</span></span>{
  glClear(GL_COLOR_BUFFER_BIT);
  glColor3f(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);
  glRectf(rect.xmin, rect.ymin, rect.xmax, rect.ymax);

  LineGL(x0, y0, x1, y1);

  glFlush();
}
<span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span></span>{
  glClearColor(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);
  glShadeModel(GL_FLAT);

  rect.xmin = <span class="number">100</span>;
  rect.xmax = <span class="number">300</span>;
  rect.ymin = <span class="number">100</span>;
  rect.ymax = <span class="number">300</span>;

  x0 = <span class="number">450</span>, y0 = <span class="number">0</span>, x1 = <span class="number">0</span>, y1 = <span class="number">450</span>;
  <span class="built_in">printf</span>(<span class="string">"Press key 'c' to Clip!\nPress key 'r' to Restore!\n"</span>);

}

<span class="function"><span class="keyword">void</span> <span class="title">Reshape</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h)</span></span>{
  glViewport(<span class="number">0</span>, <span class="number">0</span>, (GLsizei) w, (GLsizei) h);
  glMatrixMode(GL_PROJECTION);
  glLoadIdentity();
  gluOrtho2D(<span class="number">0.0</span>, (GLdouble)w, <span class="number">0.0</span>, (GLdouble)h);
}

<span class="function"><span class="keyword">void</span> <span class="title">keyboard</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> key, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>{
  <span class="keyword">switch</span> (key){
  <span class="keyword">case</span> <span class="string">'c'</span>:
    cohensutherlandlineclip(rect, x0, y0, x1, y1);
    glutPostRedisplay();
    <span class="keyword">break</span>;
  <span class="keyword">case</span> <span class="string">'r'</span>:
    Init();
    glutPostRedisplay();
    <span class="keyword">break</span>;
  <span class="keyword">case</span> <span class="string">'x'</span>:
    <span class="built_in">exit</span>(<span class="number">0</span>);
    <span class="keyword">break</span>;
  <span class="keyword">default</span>:
    <span class="keyword">break</span>;
  }
}

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>{
  glutInit(&amp;argc, argv);
  glutInitDisplayMode(GLUT_RGB | GLUT_SINGLE);
  glutInitWindowPosition(<span class="number">100</span>, <span class="number">100</span>);
  glutInitWindowSize(<span class="number">640</span>,<span class="number">480</span>);
  glutCreateWindow(<span class="string">"Cohen-Sutherland"</span>);

  Init();
  glutDisplayFunc(myDisplay);
  glutReshapeFunc(Reshape);
  glutKeyboardFunc(keyboard);
  glutMainLoop();
  <span class="keyword">return</span> <span class="number">0</span>;
}</code></pre>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://blog.csdn.net/yao1373446012/article/details/78375644">计算机图形学-直线裁剪（Cohen-Sutherland编码裁剪算法）</a></li>
</ol>
